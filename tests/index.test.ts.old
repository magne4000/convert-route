import "urlpattern-polyfill";
import type { RouteParam, RouteIR } from "../src/types.js";
import { describe, expect, test } from "vitest";
import { toPathToRegexpV6 } from "../src/adapters/path-to-regexp-v6.js";
import {
  fromPathToRegexpV8,
  toPathToRegexpV8,
} from "../src/adapters/path-to-regexp-v8.js";
import { fromRou3, toRou3 } from "../src/adapters/rou3.js";
import {
  fromURLPattern,
  toURLPatternInput,
} from "../src/adapters/urlpattern.js";
import { toRegexp } from "../src/adapters/regexp.js";
import { fromNextFs } from "../src/adapters/next-fs.js";
import { join } from "../src/utils/join.js";

function normalizeIR(params: RouteParam[]): RouteParam[] {
  return params.map((param) => {
    const normalized: RouteParam = {
      value: param.value,
      optional: param.optional ?? false,
    };

    if (param.catchAll) {
      normalized.catchAll = {
        name: param.catchAll.name,
        greedy: param.catchAll.greedy,
      };
    }

    return normalized;
  });
}

describe("Pattern → IR (Parsing Tests)", () => {
  describe("/", () => {
    test("rou3", () => {
      const result = fromRou3("/");
      expect(normalizeIR(result.params)).toEqual([]);
    });

    test("path-to-regexp-v8", () => {
      const result = fromPathToRegexpV8("/");
      expect(normalizeIR(result.params)).toEqual([]);
    });
  });

  describe("/foo", () => {
    test("rou3", () => {
      const result = fromRou3("/foo");
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
      ]);
    });

    test("path-to-regexp-v8", () => {
      const result = fromPathToRegexpV8("/foo");
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
      ]);
    });
  });

  describe("/foo/bar", () => {
    test("rou3", () => {
      const result = fromRou3("/foo/bar");
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
        { value: "bar", optional: false },
      ]);
    });
  });

  describe("/foo/:id", () => {
    test("rou3", () => {
      const result = fromRou3("/foo/:id");
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
        {
          value: ":id",
          optional: false,
          catchAll: { name: "id", greedy: false },
        },
      ]);
    });

    test("path-to-regexp-v8", () => {
      const result = fromPathToRegexpV8("/foo/:id");
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
        {
          value: ":id",
          optional: false,
          catchAll: { name: "id", greedy: false },
        },
      ]);
    });

    test("urlpattern", () => {
      const pattern = new URLPattern({ pathname: "/foo/:id{/}?" });
      const result = fromURLPattern(pattern);
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
        {
          value: ":id",
          optional: false,
          catchAll: { name: "id", greedy: false },
        },
      ]);
    });

    test("urlpatterninit", () => {
      const result = fromURLPattern({ pathname: "/foo/:id{/}?" });
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
        {
          value: ":id",
          optional: false,
          catchAll: { name: "id", greedy: false },
        },
      ]);
    });
  });

  describe("/foo/:foo/bar/:bar", () => {
    test("rou3", () => {
      const result = fromRou3("/foo/:foo/bar/:bar");
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
        {
          value: ":foo",
          optional: false,
          catchAll: { name: "foo", greedy: false },
        },
        { value: "bar", optional: false },
        {
          value: ":bar",
          optional: false,
          catchAll: { name: "bar", greedy: false },
        },
      ]);
    });
  });

  describe("/foo/*", () => {
    test("rou3", () => {
      const result = fromRou3("/foo/*");
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
        {
          value: "*",
          optional: true,
          catchAll: { name: undefined, greedy: false },
        },
      ]);
    });

    test("path-to-regexp-v8: /foo{/:_1}", () => {
      const result = fromPathToRegexpV8("/foo{/:_1}");
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
        {
          value: ":_1",
          optional: true,
          catchAll: { name: "_1", greedy: false },
        },
      ]);
    });

    test("urlpattern: /foo/:_1?", () => {
      const pattern = new URLPattern({ pathname: "/foo{/:_1}?{/}?" });
      const result = fromURLPattern(pattern);
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
        {
          value: ":_1?",
          optional: true,
          catchAll: { name: "_1", greedy: false },
        },
      ]);
    });
  });

  describe("/foo/**:_1", () => {
    test("rou3", () => {
      const result = fromRou3("/foo/**:_1");
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
        {
          value: "**:_1",
          optional: false,
          catchAll: { name: "_1", greedy: true },
        },
      ]);
    });

    test("path-to-regexp-v8: /foo/*_1", () => {
      const result = fromPathToRegexpV8("/foo/*_1");
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
        {
          value: "*_1",
          optional: false,
          catchAll: { name: "_1", greedy: true },
        },
      ]);
    });

    test("urlpattern: /foo/:_1+", () => {
      const pattern = new URLPattern({ pathname: "/foo/:_1+{/}?" });
      const result = fromURLPattern(pattern);
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
        {
          value: ":_1+",
          optional: false,
          catchAll: { name: "_1", greedy: true },
        },
      ]);
    });
  });

  describe("/foo/**", () => {
    test("rou3", () => {
      const result = fromRou3("/foo/**");
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
        {
          value: "**",
          optional: true,
          catchAll: { name: undefined, greedy: true },
        },
      ]);
    });

    test("path-to-regexp-v8: /foo{/*_1}", () => {
      const result = fromPathToRegexpV8("/foo{/*_1}");
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
        {
          value: "*_1",
          optional: true,
          catchAll: { name: "_1", greedy: true },
        },
      ]);
    });

    test("urlpattern: /foo/:_1*", () => {
      const pattern = new URLPattern({ pathname: "/foo/:_1*{/}?" });
      const result = fromURLPattern(pattern);
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
        {
          value: ":_1*",
          optional: true,
          catchAll: { name: "_1", greedy: true },
        },
      ]);
    });
  });

  describe("/foo{/:_1}/bar", () => {
    test("path-to-regexp-v8", () => {
      const result = fromPathToRegexpV8("/foo{/:_1}/bar");
      expect(normalizeIR(result.params)).toEqual([
        { value: "foo", optional: false },
        {
          value: ":_1",
          optional: true,
          catchAll: { name: "_1", greedy: false },
        },
        { value: "bar", optional: false },
      ]);
    });
  });
});

// ============================================================================
// IR → PATTERN TESTS (Generation Tests)
// ============================================================================

describe("IR → Pattern (Generation Tests)", () => {
  describe("/", () => {
    test("generates correctly for all formats", () => {
      const ir: RouteIR = { pattern: "", params: [] };
      
      expect(toRou3(ir)).toContain("/");
      expect(toPathToRegexpV6(ir)).toBe("/");
      expect(toPathToRegexpV8(ir)).toBe("/");
      expect(toURLPatternInput(ir).pathname).toBe("/{/}?");
    });
  });

  describe("/foo", () => {
    test("generates correctly for all formats", () => {
      const ir: RouteIR = {
        pattern: "",
        params: [{ value: "foo", optional: false }],
      };

      expect(toRou3(ir)).toContain("/foo");
      expect(toPathToRegexpV6(ir)).toBe("/foo");
      expect(toPathToRegexpV8(ir)).toBe("/foo");
      expect(toURLPatternInput(ir).pathname).toBe("/foo{/}?");
    });
  });

  describe("/foo/bar", () => {
    test("generates correctly for all formats", () => {
      const ir: RouteIR = {
        pattern: "",
        params: [
          { value: "foo", optional: false },
          { value: "bar", optional: false },
        ],
      };

      expect(toRou3(ir)).toContain("/foo/bar");
      expect(toPathToRegexpV6(ir)).toBe("/foo/bar");
      expect(toPathToRegexpV8(ir)).toBe("/foo/bar");
      expect(toURLPatternInput(ir).pathname).toBe("/foo/bar{/}?");
    });
  });

  describe("/foo/:id", () => {
    test("generates correctly for all formats", () => {
      const ir: RouteIR = {
        pattern: "",
        params: [
          { value: "foo", optional: false },
          {
            value: ":id",
            optional: false,
            catchAll: { name: "id", greedy: false },
          },
        ],
      };

      expect(toRou3(ir)).toContain("/foo/:id");
      expect(toPathToRegexpV6(ir)).toBe("/foo/:id");
      expect(toPathToRegexpV8(ir)).toBe("/foo/:id");
      expect(toURLPatternInput(ir).pathname).toBe("/foo/:id{/}?");
    });

    test("regexp generation", () => {
      const ir: RouteIR = {
        pattern: "",
        params: [
          { value: "foo", optional: false },
          {
            value: ":id",
            optional: false,
            catchAll: { name: "id", greedy: false },
          },
        ],
      };

      const regexp = toRegexp(ir);
      expect(regexp).toBeInstanceOf(RegExp);
      expect(regexp.test("/foo/123")).toBe(true);
      expect(regexp.test("/foo/123/")).toBe(true);
      expect(regexp.test("/bar/123")).toBe(false);
    });
  });

  describe("/foo/*", () => {
    test("generates: rou3:/foo/*, ptr8:/foo{/:_1}, urlpattern:/foo/:_1?", () => {
      const ir: RouteIR = {
        pattern: "",
        params: [
          { value: "foo", optional: false },
          {
            value: ":_1",
            optional: true,
            catchAll: { name: "_1", greedy: false },
          },
        ],
      };

      expect(toRou3(ir)).toContain("/foo/*");
      expect(toPathToRegexpV6(ir)).toBe("/foo/:_1?");
      expect(toPathToRegexpV8(ir)).toBe("/foo{/:_1}");
      expect(toURLPatternInput(ir).pathname).toBe("/foo/:_1?{/}?");
    });
  });

  describe("/foo/**:_1", () => {
    test("generates: rou3:/foo/**:_1, ptr8:/foo/*_1, urlpattern:/foo/:_1+", () => {
      const ir: RouteIR = {
        pattern: "",
        params: [
          { value: "foo", optional: false },
          {
            value: ":_1",
            optional: false,
            catchAll: { name: "_1", greedy: true },
          },
        ],
      };

      expect(toRou3(ir)).toContain("/foo/**:_1");
      expect(toPathToRegexpV6(ir)).toBe("/foo/:_1+");
      expect(toPathToRegexpV8(ir)).toBe("/foo/*_1");
      expect(toURLPatternInput(ir).pathname).toBe("/foo/:_1+{/}?");
    });
  });

  describe("/foo/**", () => {
    test("generates: rou3:/foo/**, ptr8:/foo{/*_1}, urlpattern:/foo/:_1*", () => {
      const ir: RouteIR = {
        pattern: "",
        params: [
          { value: "foo", optional: false },
          {
            value: ":_1",
            optional: true,
            catchAll: { name: "_1", greedy: true },
          },
        ],
      };

      expect(toRou3(ir)).toContain("/foo/**");
      expect(toPathToRegexpV6(ir)).toBe("/foo/:_1*");
      expect(toPathToRegexpV8(ir)).toBe("/foo{/*_1}");
      expect(toURLPatternInput(ir).pathname).toBe("/foo/:_1*{/}?");
    });
  });

  describe("/foo{/:_1}/bar", () => {
    test("generates optional segment in middle", () => {
      const ir: RouteIR = {
        pattern: "",
        params: [
          { value: "foo", optional: false },
          {
            value: ":_1",
            optional: true,
            catchAll: { name: "_1", greedy: false },
          },
          { value: "bar", optional: false },
        ],
      };

      expect(toPathToRegexpV6(ir)).toBe("/foo/:_1?/bar");
      expect(toPathToRegexpV8(ir)).toBe("/foo{/:_1}/bar");
      expect(toURLPatternInput(ir).pathname).toBe("/foo/:_1?/bar{/}?");
    });
  });

  describe("/foo/:foo/bar/:bar", () => {
    test("generates multiple named params", () => {
      const ir: RouteIR = {
        pattern: "",
        params: [
          { value: "foo", optional: false },
          {
            value: ":foo",
            optional: false,
            catchAll: { name: "foo", greedy: false },
          },
          { value: "bar", optional: false },
          {
            value: ":bar",
            optional: false,
            catchAll: { name: "bar", greedy: false },
          },
        ],
      };

      expect(toRou3(ir)).toContain("/foo/:foo/bar/:bar");
      expect(toPathToRegexpV6(ir)).toBe("/foo/:foo/bar/:bar");
      expect(toPathToRegexpV8(ir)).toBe("/foo/:foo/bar/:bar");
      expect(toURLPatternInput(ir).pathname).toBe("/foo/:foo/bar/:bar{/}?");
    });
  });
});
